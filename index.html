<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AR Event Experience - Scan & Watch</title>
    
    <!-- Mobile optimizations -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- AR.js and A-Frame -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/aframe/build/aframe-ar.js"></script>
    
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: fixed;
            background: #000;
            box-sizing: border-box;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            color: white;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* AR Scene styles - Full screen mobile fix */
        a-scene {
            width: 100vw !important;
            height: 100vh !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            z-index: 1 !important;
            display: block !important;
            visibility: visible !important;
        }
        
        /* Mobile Safari specific fixes */
        a-scene canvas {
            width: 100vw !important;
            height: 100vh !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            z-index: 1 !important;
            display: block !important;
            visibility: visible !important;
            object-fit: cover !important;
        }
        
        /* Force full viewport on all devices */
        a-scene, a-scene canvas {
            min-width: 100vw !important;
            min-height: 100vh !important;
            max-width: 100vw !important;
            max-height: 100vh !important;
        }
        
        /* Loading screen */
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s ease;
        }
        
        #loading.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .loader {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 18px;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .loading-subtext {
            font-size: 14px;
            opacity: 0.8;
            text-align: center;
            max-width: 280px;
            line-height: 1.4;
        }
        
        /* Instructions overlay */
        #instructions {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            z-index: 100;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        #instructions h2 {
            font-size: 20px;
            margin-bottom: 10px;
            color: #4CAF50;
        }
        
        #instructions p {
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 8px;
        }
        
        .step {
            display: flex;
            align-items: center;
            margin: 8px 0;
        }
        
        .step-number {
            background: #4CAF50;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            margin-right: 10px;
            flex-shrink: 0;
        }
        
        /* Hide instructions button */
        #hideInstructions {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 14px;
            margin-top: 15px;
            cursor: pointer;
            width: 100%;
        }
        
        #hideInstructions:hover {
            background: #45a049;
        }
        
        /* Video overlay styles */
        #videoOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 500;
            backdrop-filter: blur(5px);
        }
        
        #eventVideo {
            max-width: 90%;
            max-height: 90%;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        #closeVideo {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 24px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        /* Debug info */
        #debugInfo {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            max-width: 200px;
            z-index: 200;
            display: block;
        }
        
        /* Mobile specific fixes */
        @media screen and (max-width: 768px) {
            #instructions {
                top: 10px;
                left: 10px;
                right: 10px;
                padding: 15px;
            }
            
            #instructions h2 {
                font-size: 18px;
            }
            
            #instructions p {
                font-size: 13px;
            }
            
            #debugInfo {
                bottom: 10px;
                left: 10px;
                font-size: 11px;
                max-width: 150px;
            }
        }
        
        /* Prevent iOS Safari bounce */
        body {
            touch-action: none;
            -webkit-overflow-scrolling: auto;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading">
        <div class="loader"></div>
        <div class="loading-text">Loading AR Experience</div>
        <div class="loading-subtext">Please allow camera access when prompted for the best experience</div>
    </div>
    
    <!-- Instructions Overlay -->
    <div id="instructions">
        <h2>ðŸŽ¯ How to Use</h2>
        <div class="step">
            <div class="step-number">1</div>
            <p>Point your camera at the marker image</p>
        </div>
        <div class="step">
            <div class="step-number">2</div>
            <p>Keep the marker in view and steady</p>
        </div>
        <div class="step">
            <div class="step-number">3</div>
            <p>Video will auto-play when detected!</p>
        </div>
        <button id="hideInstructions">Got it! Start Scanning</button>
    </div>
    
    <!-- Video Overlay -->
    <div id="videoOverlay">
        <video id="eventVideo" controls playsinline muted>
            <source src="assets/videos/demo-video.mp4" type="video/mp4">
            Your browser does not support the video tag.
        </video>
        <button id="closeVideo">&times;</button>
    </div>
    
    <!-- Debug Info -->
    <div id="debugInfo">
        <div>Status: <span id="status">Initializing...</span></div>
        <div>Marker: <span id="markerStatus">Not detected</span></div>
        <div>Camera: <span id="cameraStatus">Starting...</span></div>
    </div>
    
    <!-- AR Scene -->
    <a-scene
        embedded
        arjs="sourceType: webcam; 
              debugUIEnabled: false; 
              detectionMode: mono_and_matrix; 
              matrixCodeType: 3x3;"
        vr-mode-ui="enabled: false"
        renderer="logarithmicDepthBuffer: true; colorManagement: true; sortObjects: true;"
        loading-screen="enabled: false"
        id="arScene">
        
        <!-- Assets -->
        <a-assets>
            <a-asset-item id="markerPattern" src="assets/markers/pattern-marker.patt"></a-asset-item>
            <video
                id="videoAsset"
                src="assets/videos/demo-video.mp4"
                preload="metadata"
                playsinline
                muted
                crossorigin="anonymous">
            </video>
        </a-assets>
        
        <!-- Camera -->
        <a-camera 
            id="camera"
            rotation-reader>
        </a-camera>
        
        <!-- Marker -->
        <a-marker
            id="markerA"
            type="pattern"
            preset="custom"
            url="assets/markers/pattern-marker.patt"
            smooth="true"
            smoothCount="10"
            smoothTolerance="0.01"
            smoothThreshold="5"
            raycaster="objects: .clickable">
            
            <!-- 3D Content on marker (optional) -->
            <a-box 
                position="0 0.5 0" 
                material="color: #4CAF50; opacity: 0.7" 
                scale="0.5 0.5 0.5"
                animation="property: rotation; to: 0 360 0; loop: true; dur: 3000">
            </a-box>
            
            <a-text 
                value="Marker Detected!" 
                position="0 1.5 0" 
                align="center" 
                color="#4CAF50"
                scale="2 2 2">
            </a-text>
        </a-marker>
    </a-scene>

    <script>
        // Mobile AR Event Experience JavaScript
        class AREventExperience {
            constructor() {
                this.scene = document.querySelector('#arScene');
                this.marker = document.querySelector('#markerA');
                this.video = document.querySelector('#eventVideo');
                this.videoOverlay = document.querySelector('#videoOverlay');
                this.loading = document.querySelector('#loading');
                this.instructions = document.querySelector('#instructions');
                this.debugInfo = document.querySelector('#debugInfo');
                
                this.markerDetected = false;
                this.videoPlaying = false;
                this.cameraReady = false;
                
                this.init();
            }
            
            init() {
                this.setupEventListeners();
                this.setupAREvents();
                this.detectMobile();
                this.requestCameraPermission();
                this.handleLoading();
            }
            
            setupEventListeners() {
                // Hide instructions
                document.querySelector('#hideInstructions').addEventListener('click', () => {
                    this.instructions.style.display = 'none';
                });
                
                // Close video
                document.querySelector('#closeVideo').addEventListener('click', () => {
                    this.closeVideo();
                });
                
                // Video ended
                this.video.addEventListener('ended', () => {
                    this.closeVideo();
                });
                
                // Handle mobile orientation
                window.addEventListener('orientationchange', () => {
                    setTimeout(() => {
                        this.handleResize();
                    }, 500);
                });
                
                // Handle page visibility (for mobile background/foreground)
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        this.pauseExperience();
                    } else {
                        this.resumeExperience();
                    }
                });
            }
            
            setupAREvents() {
                // Scene loaded
                this.scene.addEventListener('loaded', () => {
                    console.log('AR Scene loaded');
                    this.updateStatus('Scene ready');
                    this.hideLoading();
                });
                
                // Scene render start
                this.scene.addEventListener('renderstart', () => {
                    console.log('AR Scene render started');
                    this.updateStatus('Rendering...');
                });
                
                // Marker found
                this.marker.addEventListener('markerFound', () => {
                    console.log('Marker detected!');
                    this.markerDetected = true;
                    this.updateMarkerStatus('Detected!');
                    this.triggerVideo();
                });
                
                // Marker lost
                this.marker.addEventListener('markerLost', () => {
                    console.log('Marker lost');
                    this.markerDetected = false;
                    this.updateMarkerStatus('Not detected');
                });
                
                // Camera ready
                this.scene.addEventListener('camera-init', () => {
                    console.log('Camera initialized');
                    this.updateCameraStatus('Ready');
                    this.cameraReady = true;
                    this.hideLoading();
                });
                
                // Error handling
                this.scene.addEventListener('camera-error', (error) => {
                    console.error('Camera error:', error);
                    this.updateCameraStatus('Error');
                    this.showError('Camera access denied. Please enable camera permissions and refresh.');
                });
                
                // AR.js specific events
                this.scene.addEventListener('arjs-video-loaded', () => {
                    console.log('Camera video loaded');
                    this.updateCameraStatus('Video Ready');
                    this.cameraReady = true;
                    this.hideLoading();
                });
                
                // Handle getUserMedia errors
                window.addEventListener('error', (event) => {
                    if (event.message && event.message.includes('getUserMedia')) {
                        console.error('Camera access error:', event);
                        this.updateCameraStatus('Access Denied');
                        this.showError('Camera access is required for AR. Please allow camera access and refresh.');
                    }
                });
                
                // Force scene visibility after initialization
                setTimeout(() => {
                    this.ensureSceneVisible();
                }, 500);
                
                // Also run again after a bit more time
                setTimeout(() => {
                    this.ensureSceneVisible();
                    this.ensureFullScreen();
                }, 3000);
            }
            
            ensureSceneVisible() {
                const scene = document.querySelector('a-scene');
                const canvas = document.querySelector('a-scene canvas');
                
                if (scene) {
                    scene.style.display = 'block';
                    scene.style.visibility = 'visible';
                    scene.style.width = '100vw';
                    scene.style.height = '100vh';
                    scene.style.position = 'fixed';
                    scene.style.top = '0';
                    scene.style.left = '0';
                    console.log('Ensuring scene is visible and full screen');
                }
                
                if (canvas) {
                    canvas.style.display = 'block';
                    canvas.style.visibility = 'visible';
                    canvas.style.width = '100vw';
                    canvas.style.height = '100vh';
                    canvas.style.position = 'fixed';
                    canvas.style.top = '0';
                    canvas.style.left = '0';
                    canvas.style.zIndex = '1';
                    console.log('Ensuring canvas is visible and full screen');
                }
                
                this.updateStatus('Scene visible');
                this.hideLoading(); // Hide loading when scene is visible
            }
            
            async requestCameraPermission() {
                try {
                    console.log('Requesting camera permission...');
                    this.updateCameraStatus('Requesting permission...');
                    
                    // Try to get camera permission first
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: 'environment' // Use back camera for AR
                        } 
                    });
                    
                    console.log('Camera permission granted');
                    this.updateCameraStatus('Permission granted');
                    
                    // Stop the test stream
                    stream.getTracks().forEach(track => track.stop());
                    
                    // Start ensuring scene visibility after permission granted
                    setTimeout(() => {
                        this.ensureSceneVisible();
                    }, 1000);
                    
                } catch (error) {
                    console.error('Camera permission denied or not available:', error);
                    this.updateCameraStatus('Permission denied');
                    
                    // Don't show aggressive error, just log it
                    console.log('Camera access issue:', error.name);
                    
                    // Still try to show the scene, might work anyway
                    setTimeout(() => {
                        this.ensureSceneVisible();
                    }, 2000);
                }
            }
            
            triggerVideo() {
                if (this.videoPlaying) return;
                
                console.log('Triggering video playback');
                this.videoPlaying = true;
                this.videoOverlay.style.display = 'flex';
                
                // Reset video to beginning
                this.video.currentTime = 0;
                
                // Auto-play with proper mobile handling
                const playPromise = this.video.play();
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        console.log('Video started playing');
                    }).catch(error => {
                        console.log('Auto-play prevented, user interaction required:', error);
                        // On some mobile browsers, show play button
                        this.video.controls = true;
                    });
                }
            }
            
            closeVideo() {
                this.video.pause();
                this.videoOverlay.style.display = 'none';
                this.videoPlaying = false;
                console.log('Video closed');
            }
            
            detectMobile() {
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                if (isMobile) {
                    document.body.classList.add('mobile');
                    // Enable debug info on mobile for testing
                    this.debugInfo.style.display = 'block';
                    
                    // Mobile-specific viewport fixes
                    this.fixMobileViewport();
                }
                return isMobile;
            }
            
            fixMobileViewport() {
                // Force viewport meta tag for mobile
                const viewport = document.querySelector('meta[name=viewport]');
                if (viewport) {
                    viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover');
                }
                
                // Prevent iOS Safari address bar issues
                const fixViewportHeight = () => {
                    const vh = window.innerHeight * 0.01;
                    document.documentElement.style.setProperty('--vh', `${vh}px`);
                };
                
                fixViewportHeight();
                window.addEventListener('resize', fixViewportHeight);
                window.addEventListener('orientationchange', () => {
                    setTimeout(fixViewportHeight, 500);
                });
            }
            
            handleLoading() {
                // Hide loading after scene is ready or timeout (increased to 20 seconds)
                setTimeout(() => {
                    if (!this.cameraReady) {
                        this.hideLoading();
                        console.log('Loading timeout - hiding loading screen anyway');
                        this.updateStatus('Ready (timeout)');
                    }
                }, 20000);
            }
            
            hideLoading() {
                this.loading.classList.add('hidden');
                setTimeout(() => {
                    this.loading.style.display = 'none';
                }, 500);
            }
            
            handleResize() {
                // Force scene resize on mobile orientation change
                if (this.scene && this.scene.systems.renderer) {
                    this.scene.systems.renderer.renderer.setSize(window.innerWidth, window.innerHeight);
                }
                
                // Force full screen after resize
                setTimeout(() => {
                    this.ensureFullScreen();
                }, 100);
            }
            
            ensureFullScreen() {
                const canvas = document.querySelector('a-scene canvas');
                if (canvas) {
                    canvas.style.width = '100vw';
                    canvas.style.height = '100vh';
                    canvas.style.position = 'fixed';
                    canvas.style.top = '0';
                    canvas.style.left = '0';
                    canvas.style.zIndex = '1';
                    console.log('Enforcing full screen canvas');
                }
            }
            
            pauseExperience() {
                if (this.videoPlaying) {
                    this.video.pause();
                }
            }
            
            resumeExperience() {
                if (this.videoPlaying && this.video.paused) {
                    this.video.play();
                }
            }
            
            updateStatus(status) {
                document.querySelector('#status').textContent = status;
            }
            
            updateMarkerStatus(status) {
                document.querySelector('#markerStatus').textContent = status;
            }
            
            updateCameraStatus(status) {
                document.querySelector('#cameraStatus').textContent = status;
            }
            
            showError(message) {
                alert(message);
            }
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Initializing AR Event Experience');
            window.arExperience = new AREventExperience();
        });
    </script>
</body>
</html> 